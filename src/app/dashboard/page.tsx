import { currentUser } from '@clerk/nextjs/server';import { supabase } from '@/lib/supabase';import { getPoolWeek } from '@/lib/week';import Link from 'next/link';import { getAllowlist } from '@/lib/allowlist'
export const dynamic='force-dynamic'
export default async function Dashboard(){const user=await currentUser();const allow=getAllowlist();const email=(user?.emailAddresses?.[0]?.emailAddress||'').toLowerCase();if(!user||!allow.has(email)){return(<main className='main section'><div className='card p-6'><h1 className='h1'>Access pending</h1><p className='subtle'>Your email isn’t on the league list yet.</p><Link href='/' className='underline mt-3 inline-block'>Back to Home</Link></div></main>)}const week=getPoolWeek();const{data:mapRow}=await supabase.from('user_teams').select('team_id').eq('email',email).maybeSingle();if(!mapRow){return(<main className='main section'><div className='card p-6'><h1 className='h1'>No team assigned</h1><p className='subtle'>Ask the commissioner to link your email to a team.</p></div></main>)}const teamId=(mapRow as any).team_id as string;const[{data:team},{data:weekly},{data:standings},{data:matchup}] = await Promise.all([supabase.from('teams').select('name').eq('id',teamId).single(),supabase.from('team_week_stats').select('*').eq('team_id',teamId).eq('week',week).maybeSingle(),supabase.from('v_standings').select('*').eq('team_id',teamId).single(),supabase.from('v_weekly_match_results').select('*').eq('week',week).or(`team_a.eq.${teamId},team_b.eq.${teamId}`).maybeSingle()]);const teamName=(team as any)?.name||'Your Team';const goals=(weekly as any)?.goals??0,assists=(weekly as any)?.assists??0,picks=(weekly as any)?.correct_picks??0;const total=goals*4+assists*2+picks;let oppName='—',youPts=total,oppPts=0;if(matchup){const{data:allTeams}=await supabase.from('teams').select('id,name');const tmap=new Map((allTeams||[]).map(t=>[t.id,t.name]));const m=matchup as any;const youAreA=m.team_a===teamId;const oppId=youAreA?m.team_b:m.team_a;oppName=tmap.get(oppId)||'—';youPts=youAreA?m.pts_a:m.pts_b;oppPts=youAreA?m.pts_b:m.pts_a}return(<main className='main section'><h1 className='h1'>{teamName} — Dashboard</h1><div className='grid gap-4 sm:grid-cols-2'><div className='card p-5'><h2 className='h2'>This Week (Week {week})</h2><div className='mt-2 text-sm'><div className='flex justify-between'><span>Goals</span><span className='font-medium'>{goals}</span></div><div className='flex justify-between'><span>Assists</span><span className='font-medium'>{assists}</span></div><div className='flex justify-between'><span>Correct Picks</span><span className='font-medium'>{picks}</span></div><div className='flex justify-between border-t mt-2 pt-2'><span>Total (4/2/1)</span><span className='font-semibold'>{total}</span></div></div></div><div className='card p-5'><h2 className='h2'>Matchup (Week {week})</h2><p className='subtle mt-1'>You vs. {oppName}</p><div className='mt-3 text-sm'><div className='flex justify-between'><span>You</span><span className='font-semibold'>{youPts}</span></div><div className='flex justify-between'><span>{oppName}</span><span className='font-semibold'>{oppPts}</span></div></div><Link href='/matchups' className='underline text-sm mt-3 inline-block'>View all matchups</Link></div><div className='card p-5 sm:col-span-2'><h2 className='h2'>Season Record</h2><div className='mt-2 text-sm'><div className='flex justify-between'><span>Wins</span><span className='font-semibold'>{(standings as any)?.wins??0}</span></div><div className='flex justify-between'><span>Losses</span><span className='font-semibold'>{(standings as any)?.losses??0}</span></div><div className='flex justify-between'><span>Total Points</span><span className='font-semibold'>{(standings as any)?.points_total??0}</span></div></div><Link href='/standings' className='underline text-sm mt-3 inline-block'>League standings</Link></div></div></main>)}
